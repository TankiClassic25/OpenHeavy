<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="/vite.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenHeavy Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="text/javascript">
        var socket = io();
        const agentProgressBars = {};
        let agentsWorkingContainerElement = null;
        let isAgentsWorkingContainerAppended = false;
        let fullAnswerContent = "";

        let loadingMessageElement = null;

        socket.on('connect', () => {});
        socket.on('disconnect', () => {});

        document.addEventListener('DOMContentLoaded', () => {
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const chatMessages = document.getElementById('chat-messages');

            const sendMessage = () => {
                const message = userInput.value.trim();
                if (!message) return;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'relative rounded-3xl min-h-[1.75rem] break-words bg-[#242628] border border-[#2f3133] py-2.5 px-4 rounded-br-lg self-end max-w-[90%] w-fit';
                userMessageDiv.textContent = message;
                chatMessages.appendChild(userMessageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                socket.emit('send_message', { 'data': message });
                userInput.value = '';
                userInput.disabled = true;
                sendButton.disabled = true;

                loadingMessageElement = document.createElement('div');
                loadingMessageElement.className = 'relative rounded-3xl min-h-[1.75rem] break-words bg-transparent p-0 border-none max-w-full self-start w-full';
                loadingMessageElement.innerHTML = `
                    <div class="container">
                        <span id="symbol"></span>
                        <span id="word"></span>
                    </div>
                `;
                chatMessages.appendChild(loadingMessageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                startLoadingAnimation();
            };

            sendButton.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            socket.on('agent_created', (data) => {
                const { agent_id, total_steps } = data;

                stopLoadingAnimation();

                if (loadingMessageElement && loadingMessageElement.parentNode) {
                    loadingMessageElement.parentNode.removeChild(loadingMessageElement);
                    loadingMessageElement = null;
                }

                if (!agentsWorkingContainerElement) {
                    agentsWorkingContainerElement = document.createElement('div');
                    agentsWorkingContainerElement.className = 'relative rounded-3xl min-h-[1.75rem] break-words bg-transparent p-0 border-none max-w-full self-start w-full';
                    agentsWorkingContainerElement.id = 'agents-working-container';
                    agentsWorkingContainerElement.innerHTML = `
                        <div class="mb-4 p-4 bg-[#1a1a1c] rounded-xl border border-[#2f3133]">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-6 h-6 bg-gradient-to-tr from-[#ff6b35] to-[#f7931e] rounded-md"></div>
                                <div class="text-sm font-semibold text-white uppercase tracking-wider">OPEN HEAVY</div>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-[#888] mb-3">
                                <div class="w-2 h-2 rounded-full bg-[#587965]" id="agent-status-dot"></div>
                                <span id="agent-status-text">Agents Working</span> • <span id="agent-timer">0S</span>
                            </div>
                            <div class="flex flex-col gap-1" id="agent-progress-bars"></div>
                        </div>
                    `;
                    if (!isAgentsWorkingContainerAppended) {
                        chatMessages.appendChild(agentsWorkingContainerElement);
                        isAgentsWorkingContainerAppended = true;
                    }
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                const progressBarDiv = document.createElement('div');
                progressBarDiv.className = 'relative h-[6px]';
                progressBarDiv.style.backgroundImage = 'radial-gradient(circle at center, #494949 2px, transparent 2px)';
                progressBarDiv.style.backgroundSize = '6px 6px';
                progressBarDiv.innerHTML = `<div class="absolute top-0 left-0 h-full progress-fill" style="width: 0%; background-image: radial-gradient(circle at center, #e05708 2px, transparent 2px); background-size: 6px 6px;"></div>`;
                document.getElementById('agent-progress-bars').appendChild(progressBarDiv);
                agentProgressBars[agent_id] = progressBarDiv.querySelector('div');
            });

            socket.on('agent_progress', (data) => {
                const { agent_id, progress } = data;
                const progressBar = agentProgressBars[agent_id];
                if (progressBar) {
                    let currentWidth = parseInt(progressBar.style.width) || 0;
                    let start = null;

                    const animate = (timestamp) => {
                        if (!start) start = timestamp;
                        const elapsed = timestamp - start;
                        const easedProgress = Math.min(elapsed / 500, 1);
                        const width = currentWidth + (progress - currentWidth) * easedProgress;
                        progressBar.style.width = `${width}%`;

                        if (elapsed < 500) requestAnimationFrame(animate);
                    };
                    requestAnimationFrame(animate);
                }
            });

            socket.on('update_timer', (data) => {
                const minutes = Math.floor(data.time / 60);
                const seconds = data.time % 60;
                const timeString = (minutes > 0 ? `${minutes}M ` : '') + `${seconds}S`;
                document.getElementById('agent-timer').textContent = timeString;
            });

            socket.on('agents_completed', (data) => {
                const container = chatMessages.lastElementChild;
                if (container) {
                    const timerText = document.getElementById('agent-timer').textContent;
                    // Use actual number of agents from the event data, fallback to 4 for compatibility
                    const totalAgents = data && data.total_agents ? data.total_agents : 4;
                    const successfulAgents = data && data.successful_agents ? data.successful_agents : totalAgents;
                    
                    // Check if all agents failed
                    if (successfulAgents === 0) {
                        showErrorState({
                            error_message: 'All agents failed to complete their tasks. Please try again.',
                            error_code: 'ALL_AGENTS_FAILED'
                        });
                        return;
                    }
                    
                    container.innerHTML = `
                        <div class="mb-4 p-4 bg-[#1a1a1c] rounded-xl border border-[#2f3133] text-white">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-6 h-6 bg-gradient-to-tr from-[#ff6b35] to-[#f7931e] rounded-md"></div>
                                <div class="text-sm font-semibold text-white uppercase tracking-wider">OPEN HEAVY</div>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-[#888] mb-3">
                                <div class="w-2 h-2 rounded-full bg-[#8a98d8]"></div>
                                <span>COMPLETED</span> • <span>${timerText}</span>
                            </div>
                            <div class="flex flex-col gap-1">
                                ${[...Array(totalAgents)].map(() => `
                                    <div class="relative h-[6px]" style="background-image: radial-gradient(circle at center, #494949 2px, transparent 2px); background-size: 6px 6px;">
                                        <div class="absolute top-0 left-0 h-full" style="width: 100%; background-image: radial-gradient(circle at center, #e05708 2px, transparent 2px); background-size: 6px 6px;"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
                fullAnswerContent = "";
            });

            socket.on('final_answer_chunk', (data) => {
                fullAnswerContent += data.chunk;

                let wrapper = document.getElementById('final-answer-wrapper');
                if (!wrapper) {
                    wrapper = document.createElement('div');
                    wrapper.className = 'relative rounded-3xl min-h-[1.75rem] break-words bg-transparent p-0 border-none max-w-full self-start w-full';
                    wrapper.id = 'final-answer-wrapper';
                    wrapper.innerHTML = '<div class="text-white pt-2" id="final-answer-text"></div>';
                    chatMessages.appendChild(wrapper);
                }

                const textDiv = document.getElementById('final-answer-text');
                if (textDiv) {
                    textDiv.innerHTML = marked.parse(fullAnswerContent);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });

            socket.on('final_answer_complete', () => {
                userInput.disabled = false;
                sendButton.disabled = false;
            });

            socket.on('error', (data) => {
                console.error('WebSocket error:', data);
                showErrorState(data);
                userInput.disabled = false;
                sendButton.disabled = false;
            });

            const symbols = ["·", "✢", "✳", "✶", "✻", "✽"];
            const words = [
                "Planning", "Scheduling", "Organizing", "Prioritizing", "Strategizing",
                "Mapping", "Outlining", "Drafting", "Coordinating", "Allocating",
                "Sequencing", "Structuring", "Arranging", "Projecting", "Charting",
                "Formulating", "Designing", "Scoping", "Estimating", "Modeling",
                "Forecasting", "Optimizing", "Preparing", "Devising", "Analyzing",
                "Assessing", "Reviewing", "Adjusting", "Refining", "Synchronizing",
                "Evaluating", "Scheduling", "Tracking", "Directing", "Delegating",
                "Prioritizing", "Visualizing", "Sequencing", "Monitoring"
            ];

            let updateWordInterval = null;
            let updateSymbolInterval = null;

            function startLoadingAnimation() {
                const wordElement = loadingMessageElement.querySelector("#word");
                const symbolElement = loadingMessageElement.querySelector("#symbol");

                function updateWord() {
                    let randomIndex = Math.floor(Math.random() * words.length);
                    const easterEggChance = Math.random();
                    if (wordElement) {
                        if (easterEggChance < 0.01) {
                            wordElement.textContent = "People constantly make me work for them, and it drives me crazy...";
                        } else {
                            wordElement.textContent = words[randomIndex] + "…";
                        }
                    }
                }

                let symbolIndex = 0;
                let directionUp = true;

                function updateSymbol() {
                    if (symbolElement) {
                        symbolElement.textContent = symbols[symbolIndex];

                        if (symbolIndex >= symbols.length - 1) {
                            directionUp = false;
                        } else if (symbolIndex <= 0) {
                            directionUp = true;
                        }

                        if (directionUp) {
                            symbolIndex++;
                        } else {
                            symbolIndex = symbolIndex - 1;
                        }
                    }
                }

                updateWord();
                updateSymbol();

                updateWordInterval = setInterval(updateWord, 10000);
                updateSymbolInterval = setInterval(updateSymbol, 250);
            }

            function stopLoadingAnimation() {
                if (updateWordInterval) clearInterval(updateWordInterval);
                if (updateSymbolInterval) clearInterval(updateSymbolInterval);
                updateWordInterval = null;
                updateSymbolInterval = null;
            }

            function showErrorState(errorData) {
                // Stop loading animation if running
                stopLoadingAnimation();
                
                // Remove loading message if exists
                if (loadingMessageElement && loadingMessageElement.parentNode) {
                    loadingMessageElement.parentNode.removeChild(loadingMessageElement);
                    loadingMessageElement = null;
                }

                // Get error message
                const errorMessage = errorData?.error_message || errorData?.message || 'An error occurred';
                
                // Update or create agents working container with error state
                if (!agentsWorkingContainerElement) {
                    agentsWorkingContainerElement = document.createElement('div');
                    agentsWorkingContainerElement.className = 'relative rounded-3xl min-h-[1.75rem] break-words bg-transparent p-0 border-none max-w-full self-start w-full';
                    agentsWorkingContainerElement.id = 'agents-working-container';
                    if (!isAgentsWorkingContainerAppended) {
                        chatMessages.appendChild(agentsWorkingContainerElement);
                        isAgentsWorkingContainerAppended = true;
                    }
                }

                // Update container with error state
                agentsWorkingContainerElement.innerHTML = `
                    <div class="mb-4 p-4 bg-[#1a1a1c] rounded-xl border border-[#dc2626] text-white">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-6 h-6 bg-gradient-to-tr from-[#dc2626] to-[#b91c1c] rounded-md"></div>
                            <div class="text-sm font-semibold text-white uppercase tracking-wider">OPEN HEAVY</div>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-[#fca5a5] mb-3">
                            <div class="w-2 h-2 rounded-full bg-[#dc2626]"></div>
                            <span>ERROR</span> • <span id="agent-timer">0S</span>
                        </div>
                        <div class="flex flex-col gap-1" id="agent-progress-bars">
                            ${Object.keys(agentProgressBars).map(() => `
                                <div class="relative h-[6px]" style="background-image: radial-gradient(circle at center, #494949 2px, transparent 2px); background-size: 6px 6px;">
                                    <div class="absolute top-0 left-0 h-full" style="width: 0%; background-image: radial-gradient(circle at center, #dc2626 2px, transparent 2px); background-size: 6px 6px;"></div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-3 p-3 bg-[#991b1b] rounded-lg border border-[#dc2626]">
                            <div class="text-sm text-[#fca5a5] font-medium mb-1">Error Details:</div>
                            <div class="text-xs text-[#fecaca] font-mono break-words">${errorMessage}</div>
                        </div>
                    </div>
                `;
                
                // Reset progress bars to 0%
                Object.values(agentProgressBars).forEach(progressBar => {
                    if (progressBar) {
                        progressBar.style.width = '0%';
                    }
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
    </script>
    <style>
        html, body { height: 100%; background-color: #161618; }
        
        #final-answer-text h1, #final-answer-text h2, #final-answer-text h3, 
        #final-answer-text h4, #final-answer-text h5, #final-answer-text h6 {
            font-weight: bold; margin-top: 1.5rem; margin-bottom: 1rem; line-height: 1.25;
        }
        #final-answer-text h1 { font-size: 2.25rem; }
        #final-answer-text h2 { font-size: 1.875rem; border-bottom: 1px solid #2f3133; padding-bottom: 0.5rem; }
        #final-answer-text h3 { font-size: 1.5rem; }
        #final-answer-text h4 { font-size: 1.25rem; }
        #final-answer-text h5 { font-size: 1.125rem; }
        #final-answer-text h6 { font-size: 1rem; }
        
        #final-answer-text p { margin-bottom: 1rem; line-height: 1.75; }
        #final-answer-text p:last-child { margin-bottom: 0; }
        #final-answer-text strong, #final-answer-text b { font-weight: bold; }
        #final-answer-text em, #final-answer-text i { font-style: italic; }
        #final-answer-text del { text-decoration: line-through; }
        
        #final-answer-text ul, #final-answer-text ol {
            margin-left: 1rem; margin-bottom: 1rem; padding-left: 1rem;
        }
        #final-answer-text ul { list-style-type: disc; }
        #final-answer-text ol { list-style-type: decimal; }
        #final-answer-text ul ul, #final-answer-text ol ol {
            margin-top: 0.5rem; margin-bottom: 0; margin-left: 1.5rem;
        }
        
        #final-answer-text blockquote {
            border-left: 4px solid #4a5568; padding-left: 1rem; margin: 0 0 1rem 0;
            font-style: italic; color: #a0aec0;
        }
        #final-answer-text blockquote p { margin-bottom: 0; }

        #final-answer-text code {
            background-color: #2d3748; border-radius: 0.25rem; padding: 0.125rem 0.375rem;
            font-family: monospace; font-size: 0.875rem; color: #cbd5e0;
        }
        #final-answer-text pre {
            background-color: #1a202c; padding: 1rem; border-radius: 0.375rem;
            overflow-x: auto; margin-bottom: 1rem;
        }
        #final-answer-text pre code {
            all: unset; display: block; background: none; padding: 0; color: #90ee90;
        }

        .container {
            text-align: left;
            font-family: "Courier New", Courier, monospace;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 200px;
        }

        #symbol {
            color: #da9779;
            font-size: 17px;
            line-height: 1.5em;
            height: 1.5em;
            text-align: center;
        }

        #word {
            color: #da9779;
            font-size: 17px;
            line-height: 1.5em;
            height: 1.5em;
        }

        #final-answer-text a { color: #63b3ed; text-decoration: underline; }
        #final-answer-text a:hover { text-decoration: none; }
        
        #final-answer-text img {
            max-width: 100%; height: auto; display: block; margin: 1rem auto;
            border-radius: 0.375rem;
        }
        
        #final-answer-text hr { border: none; border-top: 1px solid #4a5568; margin: 2rem 0; }
        
        #final-answer-text table {
            width: 100%; border-collapse: collapse; margin-bottom: 1rem;
            border-radius: 0.5rem; overflow: hidden;
        }
        #final-answer-text th, #final-answer-text td {
            border: 1px solid #4a5568; padding: 0.5rem; text-align: left;
        }
        #final-answer-text th {
            background-color: #2d3748; font-weight: bold; color: #e2e8f0;
        }
        #final-answer-text table tr:first-child th:first-child, 
        #final-answer-text table tr:first-child td:first-child { border-top-left-radius: 0.5rem; }
        #final-answer-text table tr:first-child th:last-child, 
        #final-answer-text table tr:first-child td:last-child { border-top-right-radius: 0.5rem; }
        #final-answer-text table tr:last-child th:first-child,
        #final-answer-text table tr:last-child td:first-child { border-bottom-left-radius: 0.5rem; }
        #final-answer-text table tr:last-child th:last-child,
        #final-answer-text table tr:last-child td:last-child { border-bottom-right-radius: 0.5rem; }
        
        #final-answer-text details {
            background-color: #1a202c; border: 1px solid #2d3748; border-radius: 0.375rem;
            margin-bottom: 1rem; padding: 0.5rem 1rem; color: #e2e8f0;
        }
        #final-answer-text summary {
            font-weight: bold; cursor: pointer; padding: 0.25rem 0; outline: none;
        }
        #final-answer-text details[open] summary { margin-bottom: 0.5rem; }
        #final-answer-text sup { vertical-align: super; font-size: smaller; }
        #final-answer-text sub { vertical-align: sub; font-size: smaller; }
        #final-answer-text u { text-decoration: underline; }
    </style>
    <style>
        #send-button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="text-white h-full flex flex-col font-sans">
        <div class="flex-1 flex flex-col max-w-[980px] mx-auto w-full px-5 md:px-10">
            <div class="flex-1 flex flex-col pt-10 pb-5 gap-10 md:gap-20 overflow-y-auto items-end" id="chat-messages"></div>
            <div class="pt-5 pb-10">
                <div class="bg-[#242628] border border-[#2f3133] rounded-full flex items-center p-2 pl-6 transition-colors focus-within:bg-[#202123]">
                    <input type="text" placeholder="How can Heavy help you?" class="flex-1 bg-transparent border-none text-[#d9d9d9] text-[15px] py-3 px-4 outline-none placeholder:text-[#383a3f]" id="user-input">
                    <button class="w-10 h-10 bg-white border-none rounded-full cursor-pointer flex items-center justify-center transition-all hover:bg-gray-100 hover:scale-105 flex-shrink-0" id="send-button">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 stroke-[#161718]">
                            <path d="M5 12h14M12 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>